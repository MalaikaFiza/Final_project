/* Mobile menu toggle */
const menuToggle = document.getElementById('menu-toggle');
const nav = document.getElementById('main-nav');
menuToggle?.addEventListener('click', () => nav.classList.toggle('active'));

/* Scrollspy / active nav highlight */
function setActiveNavOnScroll(){
  const links = document.querySelectorAll('.nav-link');
  const sections = [...document.querySelectorAll('main section[id]')];
  const fromTop = window.scrollY + 80;
  let currentId = '';
  sections.forEach(sec => { if (sec.offsetTop <= fromTop) currentId = sec.id; });
  links.forEach(a => {
    const href = a.getAttribute('href') || '';
    if (href.includes('#') && href.split('#')[1] === currentId) a.classList.add('active'); else a.classList.remove('active');
  });
}
window.addEventListener('scroll', setActiveNavOnScroll);
window.addEventListener('load', setActiveNavOnScroll);

/* Smooth scroll for anchors */
document.querySelectorAll('a[href^="#"], a[href*="index.html#"]').forEach(link => {
  link.addEventListener('click', function(e){
    const href = this.getAttribute('href');
    if (href.includes('contact.html') || href.includes('about.html') || href.includes('dashboard.php')) return;
    const id = href.split('#')[1];
    const el = document.getElementById(id);
    if (el) { e.preventDefault(); el.scrollIntoView({ behavior: 'smooth', block: 'start' }); nav.classList.remove('active'); }
  });
});

/* Reveal on scroll */
const revealEls = document.querySelectorAll('.service-card, .project-card, .hero-text');
revealEls.forEach(el => { el.style.opacity = 0; el.style.transform = 'translateY(12px)'; el.style.transition = 'transform .7s ease, opacity .7s ease'; });
function revealOnScroll(){
  revealEls.forEach(el => {
    const rect = el.getBoundingClientRect();
    if (rect.top < window.innerHeight - 80) { el.style.opacity = 1; el.style.transform = 'translateY(0)'; }
  });
}
window.addEventListener('scroll', revealOnScroll);
window.addEventListener('load', revealOnScroll);

/* Helper: escape */
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

/* Load dynamic content from data.json */
async function loadDynamicContent() {
  try {
    const res = await fetch('data.json');
    const data = await res.json();

    // About
    const about = document.getElementById('about-content');
    const aboutPage = document.getElementById('about-content-page');
    if (about) about.innerHTML = `<h2>About Me</h2><p>${escapeHtml(data.about.preview)}</p><a class="btn ghost" href="about.html">Read more</a>`;
    if (aboutPage) aboutPage.innerHTML = `<h2>About Me</h2><p>${escapeHtml(data.about.full)}</p>`;

    // Services
    const servicesContainer = document.getElementById('services-container');
    if (servicesContainer) {
      servicesContainer.innerHTML = data.services.map(s => `
        <article class="service-card">
          <img src="${s.icon}" alt="${escapeHtml(s.title)}" />
          <h3>${escapeHtml(s.title)}</h3>
          <p>${escapeHtml(s.desc)}</p>
        </article>
      `).join('');
      setTimeout(()=> document.querySelectorAll('.service-card').forEach(el=>el.classList.add('visible')), 80);
    }

    // Portfolio
    const portfolioContainer = document.getElementById('portfolio-container');
    if (portfolioContainer) {
      portfolioContainer.innerHTML = data.portfolio.map(p => `
        <div class="project-card">
          <img src="${p.img}" alt="${escapeHtml(p.title)}" />
          <div class="project-info"><h4>${escapeHtml(p.title)}</h4><p>${escapeHtml(p.desc)}</p></div>
        </div>
      `).join('');
    }
  } catch (err) {
    console.error('Failed to load data.json', err);
  }
}
loadDynamicContent();

/* Quotes API integration */
const quotesContainer = document.getElementById('quotes-container');
if (quotesContainer) {
  fetch('https://type.fit/api/quotes')
    .then(r => r.json())
    .then(list => {
      const small = list.slice(0,3);
      quotesContainer.innerHTML = small.map(q => `<blockquote>"${escapeHtml(q.text)}" — <strong>${escapeHtml(q.author||'Unknown')}</strong></blockquote>`).join('');
    })
    .catch(()=>{ quotesContainer.textContent = 'Unable to load quotes at the moment.'; });
}

/* Contact form validation & simulated submit */
const contactForm = document.getElementById('contactForm');
if (contactForm) {
  const status = document.getElementById('form-status');
  const nameEl = document.getElementById('name');
  const emailEl = document.getElementById('email');
  const msgEl = document.getElementById('message');

  function validate() {
    const name = nameEl.value.trim();
    const email = emailEl.value.trim();
    const msg = msgEl.value.trim();
    if (!name || !email || !msg) { status.textContent = 'Please fill all required fields.'; status.style.color = '#b91c1c'; return false; }
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRe.test(email)) { status.textContent = 'Please enter a valid email address.'; status.style.color = '#b91c1c'; return false; }
    status.textContent = ''; return true;
  }

  nameEl?.addEventListener('input', validate);
  emailEl?.addEventListener('input', validate);
  msgEl?.addEventListener('input', validate);

  contactForm.addEventListener('submit', function(e){
    e.preventDefault();
    if (!validate()) return;
    status.textContent = 'Message sent successfully — thank you!'; status.style.color = '#065f46';
    contactForm.reset();
  });
}

/* ==== Admin: loadItems, deleteItem (used on dashboard) ==== */
async function loadItems(searchTerm='') {
  const container = document.getElementById('itemsContainer');
  if (!container) return;
  container.innerHTML = '<p>Loading…</p>';
  try {
    const res = await fetch('api_get_items.php');
    const data = await res.json();
    if (!data.success) { container.innerHTML = '<p>Failed to load items.</p>'; return; }
    let items = data.items || [];
    if (searchTerm) { items = items.filter(i => (i.title||'').toLowerCase().includes(searchTerm.toLowerCase())); }
    if (items.length === 0) { container.innerHTML = '<p>No items found.</p>'; return; }
    let html = '<table class="items-table"><thead><tr><th>Title</th><th>Description</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
    for (const it of items) {
      const short = (it.description||'').length > 120 ? it.description.slice(0,120)+'…' : it.description;
      html += `<tr data-id="${it.id}">
        <td>${escapeHtml(it.title)}</td>
        <td>${escapeHtml(short)}</td>
        <td>${escapeHtml(it.created_at)}</td>
        <td><a class="btn ghost" href="edit_item.php?id=${it.id}">Edit</a> <button class="btn" onclick="confirmDelete(${it.id}, this)">Delete</button></td>
      </tr>`;
    }
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (err) { container.innerHTML = '<p>Error loading items.</p>'; console.error(err); }
}

function confirmDelete(id, btn) {
  if (!confirm('Delete this item? This cannot be undone.')) return;
  deleteItem(id, btn);
}

async function deleteItem(id, btn) {
  btn.disabled = true; const original = btn.textContent; btn.textContent = 'Deleting…';
  try {
    const res = await fetch('delete_item.php', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id}) });
    const data = await res.json();
    if (data.success) {
      const tr = document.querySelector(`tr[data-id="${id}"]`);
      if (tr) tr.remove();
    } else alert('Delete failed: ' + (data.error||'Unknown'));
  } catch (err) { alert('Error deleting item.'); console.error(err); }
  btn.disabled = false; btn.textContent = original;
}
